@prefix rdf:  <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs:  <http://www.w3.org/2000/01/rdf-schema#> .
@prefix owl:   <http://www.w3.org/2002/07/owl#> .
@prefix vitro: <http://vitro.mannlib.cornell.edu/ns/vitro/0.7#> .
@prefix dynapi: <https://vivoweb.org/ontology/vitro-dynamic-api#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

<https://vivoweb.org/procedure/create_report_generator>
        a                                   dynapi:Procedure ;
        rdfs:label                          "Create report procedure"@en-US ;
        dynapi:hasFirstStep                 <https://vivoweb.org/procedure/create_report/fill_in_report_generation_procedure/step> ;
        dynapi:providesParameter            <https://vivoweb.org/procedure/create_report/parameter/report_generator_uri>  .
        
####################################################################################################################################################################################
#Fill in report generation procedure

<https://vivoweb.org/procedure/create_report/fill_in_report_generation_procedure/step>
        a                                   dynapi:OperationalStep ;
        rdfs:label                          "Fill in report generation procedure"@en-US ;
        dynapi:hasOperation                 <https://vivoweb.org/procedure/create_report/fill_in_report_generation_procedure/n3template> ;
        dynapi:hasNextStep                  <https://vivoweb.org/procedure/create_report/fill_in_construct_query_templates/step> .

<https://vivoweb.org/procedure/create_report/fill_in_report_generation_procedure/n3template>
        a                                   dynapi:N3Template ;
        dynapi:hasModel                     <https://vivoweb.org/procedure/create_report/parameter/report_generation_configuration_graph> ;
        dynapi:requiresParameter            <https://vivoweb.org/procedure/create_report/parameter/report_generation_step_uri> ;
        dynapi:requiresParameter            <https://vivoweb.org/procedure/create_report/parameter/report_generator_uri> ;
        dynapi:requiresParameter            <https://vivoweb.org/procedure/create_report/parameter/report_param_uri> ;
        dynapi:N3TextAdditions              
        """
        ?report_generator_uri
        	a                                   dynapi:Procedure ;
        	dynapi:hasFirstStep                 ?report_generation_step_uri ;
                dynapi:providesParameter            ?report_param_uri .
        
	?report_param_uri
		a                                   dynapi:Parameter ;
		dynapi:name                         "report" ;
		dynapi:hasType                      <https://vivoweb.org/parameter/type/binary-file> .
        """ .
        
####################################################################################################################################################################################
#Loop to fill in construct queries and get map name -> graph parameter uri

<https://vivoweb.org/procedure/create_report/fill_in_construct_query_templates/step>
        a                                   dynapi:OperationalStep ;
        rdfs:label                          "Fill out provided construct queries"@en-US ;
        dynapi:hasOperation                 <https://vivoweb.org/procedure/create_report/fill_in_construct_query_templates/loop> ;
        dynapi:hasNextStep                  <https://vivoweb.org/procedure/create_report/fill_in_select_query_templates/step> .

<https://vivoweb.org/procedure/create_report/fill_in_construct_query_templates/loop>
        a                                   dynapi:LoopOperation ;
        #get construct query settings from array
        dynapi:inputDescriptor              <https://vivoweb.org/procedure/create_report/fill_in_construct_query_templates/input_descriptor> ;
        dynapi:conditionDescriptor          <https://vivoweb.org/procedure/create_report/fill_in_construct_query_templates/condition_descriptor> ;
        
        dynapi:outputDescriptor             <test:outputDescriptor> ;
        dynapi:executableDescriptor         <https://vivoweb.org/procedure/create_report/fill_in_construct_query_templates/executable_descriptor> ;
        
        dynapi:internalParameter            <https://vivoweb.org/procedure/create_report/parameter/iteration_int_param> ;
        
        dynapi:internalParameter            <https://vivoweb.org/procedure/create_report/parameter/container/query_graph_names> ;
        dynapi:providesParameter            <https://vivoweb.org/procedure/create_report/parameter/container/query_graph_names> .
        

<https://vivoweb.org/procedure/create_report/fill_in_construct_query_templates/input_descriptor>
        a                                   dynapi:ProcedureDescriptor ;
        dynapi:providesParameter            <https://vivoweb.org/procedure/get_construct_from_container/parameter/container_construct_item> ;
        dynapi:requiresParameter            <https://vivoweb.org/procedure/get_construct_from_container/parameter/container_item_key> ;
        dynapi:requiresParameter            <https://vivoweb.org/procedure/create_report/parameter/container/construct_queries> ;
        dynapi:call                         <https://vivoweb.org/procedure/get_construct_from_container> .

<https://vivoweb.org/procedure/create_report/fill_in_construct_query_templates/condition_descriptor>
        a                                   dynapi:ProcedureDescriptor ;
        dynapi:providesParameter            <https://vivoweb.org/procedure/contains_construct_item/parameter/expected_result> ;
        dynapi:requiresParameter            <https://vivoweb.org/procedure/get_construct_from_container/parameter/container_item_key> ;
        dynapi:requiresParameter            <https://vivoweb.org/procedure/create_report/parameter/container/construct_queries> ;
        dynapi:call                         <https://vivoweb.org/procedure/contains_construct_item> .
        
<https://vivoweb.org/procedure/create_report/fill_in_construct_query_templates/executable_descriptor>
        a                                   dynapi:ProcedureDescriptor ;
        dynapi:requiresParameter            <https://vivoweb.org/procedure/create_report/parameter/graph/report_generator_configuration_graph> ;
        dynapi:requiresParameter            <https://vivoweb.org/procedure/create_report/parameter/report_generation_step_uri> ;
        dynapi:requiresParameter            <https://vivoweb.org/procedure/create_report/parameter/container/query_graph_names> ;
        dynapi:call                         <https://vivoweb.org/procedure/add_report_generator_construct_query> .        

        
<https://vivoweb.org/procedure/create_report/parameter/iteration_int_param>
        a                                   dynapi:Parameter ;
        dynapi:name                         "iteration_param" ;
        dynapi:defaultValue                 "0" ;
        dynapi:hasType                      <https://vivoweb.org/ontology/vitro-dynamic-api/parameter/type/integer> .

#################################################################################################################################################################################### 
#add_report_generator_constuct_query

<https://vivoweb.org/procedure/add_report_generator_construct_query>
        a                                   dynapi:Procedure ;
        dynapi:hasFirstStep                 <https://vivoweb.org/procedure/add_report_generator_construct_query/step> .

#################################################################################################################################################################################### 
#Get construct from a container 

<https://vivoweb.org/procedure/get_construct_from_container>
        a                                   dynapi:Procedure ;
        dynapi:hasFirstStep                 <https://vivoweb.org/procedure/get_construct_from_container/step> ;
        dynapi:providesParameter            <https://vivoweb.org/procedure/get_construct_from_container/parameter/container_construct_item> .
        
<https://vivoweb.org/procedure/get_construct_from_container/step> 
        a                                   dynapi:OperationalStep ;
        dynapi:hasOperation                 <https://vivoweb.org/procedure/get_construct_from_container/operation> .
        
<https://vivoweb.org/procedure/get_construct_from_container/operation>
 	a                                   dynapi:ContainerQuery ;
 	dynapi:providesParameter            <https://vivoweb.org/procedure/get_construct_from_container/parameter/container_construct_item> ;
 	dynapi:targetContainer              <https://vivoweb.org/procedure/create_report/parameter/container/construct_queries> ;
 	dynapi:requiresParameter            <https://vivoweb.org/procedure/get_construct_from_container/parameter/container_item_key> .
 	       
<https://vivoweb.org/procedure/get_construct_from_container/parameter/container_construct_item>
        a                                   dynapi:Parameter ;
        dynapi:name                         "item" ;
        dynapi:hasType                      <https://vivoweb.org/ontology/vitro-dynamic-api/parameter/type/JsonContainer> .
        
<https://vivoweb.org/procedure/get_construct_from_container/parameter/container_item_key>
        a                                   dynapi:Parameter ;
        dynapi:name                         "item_key" ;
        dynapi:hasType                      <https://vivoweb.org/ontology/vitro-dynamic-api/parameter/type/integer> .
        
#Condition procedure

<https://vivoweb.org/procedure/contains_construct_item>
        a                                   dynapi:Procedure ;
        dynapi:providesParameter            <https://vivoweb.org/procedure/contains_construct_item/parameter/result> ;
        dynapi:hasFirstStep                 <https://vivoweb.org/procedure/contains_construct_item/conditional_step> .
        
<https://vivoweb.org/procedure/contains_construct_item/conditional_step>
        a                                   dynapi:ConditionalStep ;
        dynapi:nextIfSatisfied              <https://vivoweb.org/procedure/contains_construct_item/condition_satisfied_step> ;
        dynapi:hasCondition                 <https://vivoweb.org/procedure/contains_construct_item/condition_container_contains> .
        
<https://vivoweb.org/procedure/contains_construct_item/condition_satisfied_step>
        a                                   dynapi:OperationalStep ;
        dynapi:hasOperation                 <https://vivoweb.org/procedure/contains_construct_item/addOperation> .
        
<https://vivoweb.org/procedure/contains_construct_item/addOperation>
	a                                   dynapi:SumOperation ;
	dynapi:requiresParameter            <https://vivoweb.org/procedure/contains_construct_item/parameter/add_int_1_param> ;
	dynapi:requiresParameter            <https://vivoweb.org/procedure/contains_construct_item/parameter/result> ;
	dynapi:providesParameter            <https://vivoweb.org/procedure/contains_construct_item/parameter/result> .

<https://vivoweb.org/procedure/contains_construct_item/condition_container_contains> 
        a                                   dynapi:ConditionContainerContains ;
        dynapi:targetContainer              <https://vivoweb.org/procedure/create_report/parameter/container/construct_queries> ;
        dynapi:requiresParameter            <https://vivoweb.org/procedure/get_construct_from_container/parameter/container_item_key> .
        
<https://vivoweb.org/procedure/contains_construct_item/parameter/result>
        a                                   dynapi:Parameter ;
        dynapi:name                         "condition_result" ;
        dynapi:defaultValue                 "0" ;
        dynapi:isInternal                   "true"^^xsd:boolean ;
        dynapi:hasType                      <https://vivoweb.org/ontology/vitro-dynamic-api/parameter/type/integer> .
        
<https://vivoweb.org/procedure/contains_construct_item/parameter/expected_result>
        a                                   dynapi:Parameter ;
        dynapi:name                         "condition_result" ;
        dynapi:defaultValue                 "1" ;
        dynapi:hasType                      <https://vivoweb.org/ontology/vitro-dynamic-api/parameter/type/integer> .

<https://vivoweb.org/procedure/contains_construct_item/parameter/add_int_1_param>
        a                                   dynapi:Parameter ;
        dynapi:name                         "int_1" ;
        dynapi:defaultValue                 "1" ;
        dynapi:isInternal                   "true"^^xsd:boolean ;
        dynapi:hasType                      <https://vivoweb.org/ontology/vitro-dynamic-api/parameter/type/integer> .

####################################################################################################################################################################################
#Loop to fill out select queries

<https://vivoweb.org/procedure/create_report/fill_in_select_query_templates/step>
        a                                   dynapi:OperationalStep ;
        rdfs:label                          "Fill out provided select queries"@en-US ;
        dynapi:hasOperation                 <https://vivoweb.org/procedure/create_report/fill_in_select_query_templates/loop> ;
        dynapi:hasNextStep                  <https://vivoweb.org/procedure/create_report/fill_in_report_generation_component/step> .
        
<https://vivoweb.org/procedure/create_report/fill_in_select_query_templates/loop>
        a                                   dynapi:LoopOperation ;
        dynapi:inputDescriptor              <INPUT_PROCEDURE_SHOULD_BE_HERE> ;
	dynapi:outputDescriptor             <test:outputDescriptor> ;
        dynapi:conditionDescriptor          <test:conditionDescriptor> ;
        dynapi:executableDescriptor         <test:executableDescriptor> ;
        
        dynapi:internalParameter            <test:output_container_param> ;
        dynapi:internalParameter            <test:iteration_int_param> ;
        
        dynapi:providesParameter            <test:output_container_param> .
      
      
####################################################################################################################################################################################
#Fill out report generation component

<https://vivoweb.org/procedure/create_report/fill_in_report_generation_component/step>
        a                                   dynapi:OperationalStep ;
        rdfs:label                          "Fill report generation component"@en-US ;
        dynapi:hasOperation                 <https://vivoweb.org/procedure/create_report/fill_in_report_generation_component_sources/n3template> ;
        dynapi:hasNextStep                  <https://vivoweb.org/procedure/create_report/fill_in_report_generator_sources/step> .

<https://vivoweb.org/procedure/create_report/fill_in_report_generation_component_sources/n3template>
        a                                   dynapi:N3Template ;
        dynapi:hasModel                     <https://vivoweb.org/procedure/create_report/parameter/report_generation_configuration_graph> ;
        dynapi:requiresParameter            <https://vivoweb.org/procedure/create_report/parameter/template_base64> ;
        dynapi:requiresParameter            <https://vivoweb.org/procedure/create_report/parameter/report_generation_step_uri> ;
        dynapi:requiresParameter            <https://vivoweb.org/procedure/create_report/parameter/report_generator_operation_uri> ;
        dynapi:requiresParameter            <https://vivoweb.org/procedure/create_report/parameter/template_param_uri> ;
        dynapi:requiresParameter            <https://vivoweb.org/procedure/create_report/parameter/report_param_uri> ;
        dynapi:N3TextAdditions              
        """
        ?report_generation_step_uri
                a                                   dynapi:OperationalStep ;
                dynapi:hasOperation                 ?report_generator_operation_uri .

        ?report_generator_operation_uri 
                a                                   dynapi:ReportGenerator ;
                dynapi:template                     ?template_param_uri ;
                dynapi:report                       ?report_param_uri .
	
	?template_param_uri
		a                                   dynapi:Parameter ;
		dynapi:isInternal                   "true"^^xsd:boolean ;
		dynapi:name                         "template" ;
		dynapi:hasType                      <https://vivoweb.org/parameter/type/binary-file> ;
		dynapi:defaultValue                 ?template_base64 .
		
        """ .

####################################################################################################################################################################################
#Loop to fill in report generation data sources

<https://vivoweb.org/procedure/create_report/fill_in_report_generator_sources/step>
        a                                   dynapi:OperationalStep ;
        rdfs:label                          "Fill out report generation data sources"@en-US ;
        dynapi:hasOperation                 <https://vivoweb.org/procedure/create_report/fill_in_report_generator_sources/loop> .

<https://vivoweb.org/procedure/create_report/fill_in_report_generator_sources/loop>
        a                                   dynapi:LoopOperation ;
        dynapi:inputDescriptor              <INPUT_PROCEDURE_SHOULD_BE_HERE> ;
	dynapi:outputDescriptor             <test:outputDescriptor> ;
        dynapi:conditionDescriptor          <test:conditionDescriptor> ;
        dynapi:executableDescriptor         <test:executableDescriptor> ;
        
        dynapi:internalParameter            <test:output_container_param> ;
        dynapi:internalParameter            <test:iteration_int_param> ;
        
        dynapi:providesParameter            <test:output_container_param> .
        
######################################################################## ?report_generator_operation_uri dynapi:dataSource ?data_source_param_uri .


####################################################################################################################################################################################



#INPUT

<https://vivoweb.org/procedure/create_report/parameter/container/construct_queries>
        a                                   dynapi:Parameter ;
        dynapi:name                         "construct_queries" ;
        dynapi:hasType                      <https://vivoweb.org/ontology/vitro-dynamic-api/parameter/type/JsonContainer> .
        
<https://vivoweb.org/procedure/create_report/parameter/container/select_queries>
        a                                   dynapi:Parameter ;
        dynapi:name                         "select_queries" ;
        dynapi:hasType                      <https://vivoweb.org/ontology/vitro-dynamic-api/parameter/type/JsonContainer> .
        

<https://vivoweb.org/procedure/create_report/parameter/template_base64>
        a                                   dynapi:Parameter ;
        dynapi:name                         "template" ;
        dynapi:hasType                      <https://vivoweb.org/ontology/vitro-dynamic-api/parameter/type/string> .

#INTERNAL

<https://vivoweb.org/procedure/create_report/parameter/report_generation_configuration_graph>
        a                                   dynapi:Model ;
        dynapi:name                         "report_generator_configuration_graph" ;
        dynapi:isInternal                   "true"^^xsd:boolean ;
        dynapi:hasType                      <https://vivoweb.org/ontology/vitro-dynamic-api/parameter/type/model> .

<https://vivoweb.org/procedure/create_report/parameter/container/query_graph_names>
        a                                   dynapi:Parameter ;
        dynapi:name                         "query_graph_names" ;
        dynapi:defaultValue                 "{}" ;
        dynapi:hasType                      <https://vivoweb.org/ontology/vitro-dynamic-api/parameter/type/JsonContainer> .
        
<https://vivoweb.org/procedure/create_report/parameter/container/data_source_names>
        a                                   dynapi:Parameter ;
        dynapi:name                         "data_source_names" ;
        dynapi:defaultValue                 "{}" ;
        dynapi:hasType                      <https://vivoweb.org/ontology/vitro-dynamic-api/parameter/type/JsonContainer> .


<https://vivoweb.org/procedure/create_report/parameter/report_generator_uri>
        a                                   dynapi:Parameter ;
        dynapi:name                         "report_generator_uri" ;
        dynapi:defaultValue                 "https://vivoweb.org/procedure/report_generator/,java_uuid_base62" ;
        dynapi:isInternal                   "true"^^xsd:boolean ;
        dynapi:hasType                      <https://vivoweb.org/ontology/vitro-dynamic-api/parameter/type/generated-uri> .
        
<https://vivoweb.org/procedure/create_report/parameter/report_generator_operation_uri>
        a                                   dynapi:Parameter ;
        dynapi:name                         "report_generator_operation_uri" ;
        dynapi:isInternal                   "true"^^xsd:boolean ;
        dynapi:defaultValue                 "https://vivoweb.org/procedure/report_generator/,java_uuid_base62" ;
        dynapi:hasType                      <https://vivoweb.org/ontology/vitro-dynamic-api/parameter/type/generated-uri> .        
        
<https://vivoweb.org/procedure/create_report/parameter/report_generator_first_step_uri>
        a                                   dynapi:Parameter ;
        dynapi:name                         "report_generator_first_step_uri" ;
        dynapi:defaultValue                 "https://vivoweb.org/procedure/report_generator/,java_uuid_base62" ;
        dynapi:isInternal                   "true"^^xsd:boolean ;
        dynapi:hasType                      <https://vivoweb.org/ontology/vitro-dynamic-api/parameter/type/generated-uri> .
        
<https://vivoweb.org/procedure/create_report/parameter/report_generation_step_uri>
        a                                   dynapi:Parameter ;
        dynapi:name                         "report_generation_step_uri" ;
        dynapi:defaultValue                 "https://vivoweb.org/procedure/report_generator/,java_uuid_base62" ;
        dynapi:isInternal                   "true"^^xsd:boolean ;
        dynapi:hasType                      <https://vivoweb.org/ontology/vitro-dynamic-api/parameter/type/generated-uri> .

<https://vivoweb.org/procedure/create_report/parameter/template_param_uri>
        a                                   dynapi:Parameter ;
        dynapi:name                         "template_param_uri" ;
        dynapi:defaultValue                 "https://vivoweb.org/procedure/report_generator/,java_uuid_base62" ;
        dynapi:isInternal                   "true"^^xsd:boolean ;
        dynapi:hasType                      <https://vivoweb.org/ontology/vitro-dynamic-api/parameter/type/generated-uri> .

<https://vivoweb.org/procedure/create_report/parameter/report_param_uri>
        a                                   dynapi:Parameter ;
        dynapi:name                         "report_param_uri" ;
        dynapi:defaultValue                 "https://vivoweb.org/procedure/report_generator/,java_uuid_base62" ;
        dynapi:isInternal                   "true"^^xsd:boolean ;
        dynapi:hasType                      <https://vivoweb.org/ontology/vitro-dynamic-api/parameter/type/generated-uri> .

